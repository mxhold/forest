#!/usr/bin/env ruby

require 'io/console'

SERVER_PID_FILE = "tmp/server.pid"

def check
  puts "Running checks..."
  Dir.chdir("client") do
    unless system("npm run check")
      abort "Client check failed."
    end
  end

  Dir.chdir("server") do
    unless system("npm run check")
      abort "Server check failed."
    end
  end
  puts "Checks succeeded."
end

def build
  puts "Building..."
  Dir.chdir("client") do
    unless system("npm run build")
      abort "Client build failed."
    end
  end

  Dir.chdir("server") do
    unless system("npm run build")
      abort "Server build failed."
    end
  end
  puts "Builds succeeded."
end

def kill_server
  return unless File.exists?(SERVER_PID_FILE)
  server_pid = File.read(SERVER_PID_FILE)
  if server_pid
    Process.kill("TERM", server_pid.to_i)
    File.delete(SERVER_PID_FILE)
  end

rescue Errno::ESRCH
  # Remove stale pid file
  File.delete(SERVER_PID_FILE)
end

def start
  puts "Starting..."
  kill_server

  Dir.chdir("server") do
    system("npm run start")
  end
end

def refresh
  check
  build
  start
end

def quit
  puts "Quitting..."
  kill_server
  Process.kill("TERM", 0)
  exit
end

def help
  puts "Commands: (c)heck, (b)uild, (s)tart, (r)efresh, (q)uit"
end

help

loop do
  putc ">"
  key = STDIN.getch(min: nil, time: nil, intr: true)
  puts key

  case key
  when "c"
    check
  when "b"
    build
  when "s"
    start
  when "r"
    refresh
  when "q", "\C-c", "\C-d", "\C-z", "\e"
    quit
  else
    help
  end
end